<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EASYMECH Platform</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom tweaks for specific components */
        .leaflet-popup-content-wrapper {
            border-radius: 12px;
            padding: 0;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .leaflet-popup-content {
            margin: 10px;
            text-align: center;
            width: 200px !important;
        }
        
        /* Smooth transition for views */
        .view-section {
            transition: opacity 0.3s ease-in-out;
        }

        /* Hide scrollbar for clean UI */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* Bottom Sheet Animation */
        .bottom-sheet {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Custom Orange Pulse for User Location */
        .user-pulse {
            animation: pulse-orange 2s infinite;
        }
        @keyframes pulse-orange {
            0% {
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(249, 115, 22, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(249, 115, 22, 0);
            }
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 font-sans overflow-hidden h-screen w-screen relative">

    <!-- =========================
         VIEW 1: HOME (MAP)
    ========================== -->
    <div id="view-home" class="view-section absolute inset-0 flex flex-col z-10">
        
        <!-- Header -->
        <header class="bg-slate-900 shadow-md px-4 py-3 flex justify-between items-center z-20 relative text-white">
            <div class="flex items-center gap-4">
                <button onclick="toggleSideNav()" class="text-slate-300 hover:text-orange-500 transition">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <div>
                    <h1 class="text-2xl font-black tracking-wider text-white">EASY<span class="text-orange-500">MECH</span></h1>
                    <p class="text-[10px] text-slate-400 uppercase tracking-widest leading-none">Handyman Network</p>
                </div>
            </div>
            <button onclick="getUserLocation()" class="w-10 h-10 bg-slate-800 text-orange-500 rounded-full flex items-center justify-center hover:bg-slate-700 transition shadow-lg border border-slate-700 location-btn">
                <i class="fas fa-location-arrow"></i>
            </button>
        </header>

        <!-- Filter Bar -->
        <div class="bg-white/95 backdrop-blur-sm border-b border-slate-200 px-4 py-3 overflow-x-auto whitespace-nowrap z-20 no-scrollbar shadow-sm rounded-d-3xl">
            <button onclick="filterData(null)" id="filter-all" class="filter-btn bg-slate-900 text-white px-5 py-2  text-sm font-bold rounded-lg shadow-sm mr-2 transition-colors border border-slate-900">
                All Services
            </button>
            <!-- Categories injected here -->
            <div id="category-pills" class="inline-block"></div>
        </div>

        <!-- Map Container -->
        <div id="map" class="flex-grow w-full z-0 bg-slate-200  relative"></div>

        <!-- Bottom Sheet (Handyman List) -->
        <div id="sheet-container" class="bottom-sheet absolute bottom-0 left-0 right-0 bg-white rounded-t-3xl shadow-[0_-5px_20px_rgba(0,0,0,0.15)] z-30 flex flex-col h-[85vh] transform translate-y-[calc(100%-80px)]">
            <!-- Sheet Header / Handle -->
            <div class="h-16 flex-shrink-0 w-full flex flex-col items-center justify-center cursor-pointer bg-white rounded-t-3xl border-b border-slate-100" onclick="toggleSheet()">
                <div class="w-12 h-1.5 bg-slate-300 rounded-full mb-3"></div>
                <span id="list-header-text" class="text-sm font-bold text-slate-500 uppercase tracking-wide ">Explore Handymen Near You</span>
            </div>

            <!-- List Content -->
            <div id="list-container" class="flex-grow overflow-y-auto p-4  space-y-3 bg-slate-50 pb-20">
                <!-- Cards injected here -->
                <div class="flex flex-col items-center justify-center h-40 bg-black text-slate-400">
                    <i class="fas fa-circle-notch fa-spin text-2xl mb-2 text-orange-500"></i>
                    <p>Loading handymen...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- =========================
         VIEW 2: ITEM PROFILE
    ========================== -->
    <div id="view-item" class="view-section fixed inset-0 bg-white z-40 hidden overflow-y-auto pb-24">
        <!-- Profile Header -->
        <div class="relative h-72 bg-slate-900">
            <img id="profile-img" src="" class="w-full h-full object-cover opacity-60" alt="Profile Cover">
            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/40 to-transparent"></div>
            
            <button onclick="navigateTo('home')" class="absolute top-4 left-4 w-10 h-10 bg-black/30 backdrop-blur-md rounded-full text-white flex items-center justify-center hover:bg-black/50 transition border border-white/10">
                <i class="fas fa-arrow-left"></i>
            </button>
            
            <div class="absolute bottom-0 left-0 right-0 p-6 text-white">
                <div class="flex items-end justify-between">
                    <div>
                        <span id="profile-type" class="inline-block px-2 py-1 rounded-md bg-orange-600 text-white text-xs font-bold uppercase tracking-wider mb-2 shadow-sm">Service</span>
                        <h2 id="profile-name" class="text-3xl font-black leading-tight shadow-black drop-shadow-md">Name</h2>
                    </div>
                    <div id="profile-badge-container" class="mb-1">
                        <!-- Badge injected here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Profile Content -->
        <div class="p-6 space-y-6">
            <!-- Status Card -->
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="text-slate-400 text-xs font-bold uppercase mb-1">Status</div>
                    <div id="profile-status-text" class="font-bold text-slate-800">Checking...</div>
                </div>
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200">
                    <div class="text-slate-400 text-xs font-bold uppercase mb-1">Hours</div>
                    <div id="profile-hours" class="font-bold text-slate-800">8:00 AM - 5:00 PM</div>
                </div>
            </div>

            <!-- Location -->
            <div class="flex items-start gap-4 p-4 bg-orange-50 rounded-xl border border-orange-100">
                <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center flex-shrink-0 text-orange-600">
                    <i class="fas fa-map-marker-alt"></i>
                </div>
                <div>
                    <h3 class="text-slate-900 font-bold text-sm">Service Location</h3>
                    <p id="profile-location" class="text-slate-600 text-sm mt-1">Town, Region</p>
                </div>
            </div>

            <!-- Description -->
            <div>
                <h3 class="text-slate-900 font-bold mb-3 text-lg">About Service</h3>
                <p id="profile-desc" class="text-slate-600 leading-relaxed text-sm bg-slate-50 p-5 rounded-xl border border-slate-100 ">
                    No description available.
                </p>
            </div>
            
            <div class="h-10"></div> <!-- Spacer -->
        </div>

        <!-- Fixed Action Bar -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 px-6 flex gap-3 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-50 max-w-2xl mx-auto">
            <a id="btn-call" href="#" class="flex-1 bg-slate-800 text-white py-4 rounded-xl font-bold text-center flex items-center justify-center gap-2 hover:bg-slate-900 transition shadow-lg">
                <i class="fas fa-phone-alt"></i> Call
            </a>
            <a id="btn-whatsapp" href="#" class="flex-1 bg-green-600 text-white py-4 rounded-xl font-bold text-center flex items-center justify-center gap-2 hover:bg-green-700 transition shadow-lg shadow-green-200">
                <i class="fab fa-whatsapp text-xl"></i> WhatsApp
            </a>
        </div>
    </div>

    <!-- =========================
         VIEW 3: REGISTER
    ========================== -->
    <div id="view-register" class="view-section fixed inset-0 bg-slate-50 z-50 hidden overflow-y-auto">
        <!-- Header -->
        <div class="bg-white px-4 py-3 shadow-sm sticky top-0 z-10 flex items-center border-b border-slate-200">
            <button onclick="navigateTo('home')" class="mr-4 text-slate-500 hover:text-slate-800">
                <i class="fas fa-times text-xl"></i>
            </button>
            <h2 class="text-lg font-bold text-slate-800">Register Handyman</h2>
        </div>

        <div class="max-w-lg mx-auto p-6 pb-20">
            <div class="bg-white p-8 rounded-2xl shadow-sm border border-slate-200">
                <div class="text-center mb-8">
                    <div class="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-3 text-orange-600">
                        <i class="fas fa-hard-hat text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-black text-slate-800">Join the Network</h3>
                    <p class="text-slate-500 text-sm">Get listed on the map and find more customers.</p>
                </div>

                <form id="regForm" class="space-y-5">
                    
                    <!-- Basic Info -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Business Name</label>
                        <div class="relative">
                            <i class="fas fa-store absolute left-4 top-3.5 text-slate-400"></i>
                            <input type="text" name="name" required class="w-full pl-10 pr-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:bg-white focus:border-orange-500 focus:outline-none transition font-medium" placeholder="e.g. John's Auto Repair">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Service Type</label>
                        <div class="relative">
                            <i class="fas fa-tools absolute left-4 top-3.5 text-slate-400"></i>
                            <select name="type" required class="w-full pl-10 pr-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:bg-white focus:border-orange-500 focus:outline-none appearance-none transition font-medium">
                                <option value="">Select Service...</option>
                                <option value="Mechanic">Mechanic</option>
                                <option value="Electrician">Electrician</option>
                                <option value="Plumber">Plumber</option>
                                <option value="Carpenter">Carpenter</option>
                                <option value="AC Repair">AC Repair</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Maison">Maison</option>
                                <option value="Painter">Painter</option>
                                <option value="Welder">Welder</option>
                            </select>
                            <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-4 text-slate-500">
                                <i class="fas fa-chevron-down text-xs"></i>
                            </div>
                        </div>
                    </div>

                    <!-- Contact -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Phone</label>
                            <input type="number" name="contact" required class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:bg-white focus:border-orange-500 focus:outline-none" placeholder="024xxxxxxx">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">WhatsApp</label>
                            <input type="tel" name="whatsapp" required class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:bg-white focus:border-orange-500 focus:outline-none" placeholder="024xxxxxxx">
                        </div>
                    </div>

                    <!-- Hours & Loc Details -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Open (24h)</label>
                            <input type="number" name="open" min="0" max="23" class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:bg-white focus:border-orange-500 focus:outline-none" placeholder="8">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Close (24h)</label>
                            <input type="number" name="close" min="0" max="23" class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:bg-white focus:border-orange-500 focus:outline-none" placeholder="17">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Town</label>
                            <input type="text" name="town" required class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:bg-white focus:border-orange-500 focus:outline-none" placeholder="East Legon">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Region</label>
                            <select name="region" required class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:bg-white focus:border-orange-500 focus:outline-none text-sm">
                                <option value="">Select...</option>
                                <option value="Ashanti Region">Ashanti</option>
                                <option value="Greater Accra">Greater Accra</option>
                                <option value="Central Region">Central</option>
                                <option value="Eastern Region">Eastern</option>
                                <option value="Western Region">Western</option>
                                <option value="Volta Region">Volta</option>
                                <option value="Northern Region">Northern</option>
                            </select>
                        </div>
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Description</label>
                        <textarea name="desc" rows="3" required class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-200 focus:bg-white focus:border-orange-500 focus:outline-none" placeholder="Describe your services briefly..."></textarea>
                    </div>

                    <!-- Image Upload -->
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">Profile Photo</label>
                        <label class="flex flex-col items-center justify-center w-full h-40 border-2 border-slate-300 border-dashed rounded-xl cursor-pointer bg-slate-50 hover:bg-orange-50 hover:border-orange-300 transition relative overflow-hidden group">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6 text-slate-400 group-hover:text-orange-500">
                                <i class="fas fa-camera text-3xl mb-3"></i>
                                <p class="text-sm font-medium">Tap to upload shop photo</p>
                            </div>
                            <input id="fileInput" type="file" class="hidden" accept="image/*" required />
                            <img id="img-preview" class="absolute inset-0 w-full h-full object-cover hidden" />
                        </label>
                    </div>

                    <!-- GPS Location -->
                    <div class="bg-orange-50 p-4 rounded-xl border border-orange-100">
                        <div class="flex items-center gap-2 mb-2">
                            <i class="fas fa-satellite-dish text-orange-600"></i>
                            <label class="text-xs font-bold text-orange-800 uppercase tracking-wide">GPS Location (Required)</label>
                        </div>
                        <button type="button" onclick="getRegLocation()" id="btn-get-loc" class="w-full bg-white text-orange-600 font-bold py-3 rounded-lg shadow-sm border border-orange-200 flex items-center justify-center gap-2 hover:bg-orange-100 transition">
                            <span>Get Current Location</span>
                        </button>
                        <div class="flex gap-2 mt-3">
                            <input type="text" id="reg-lat" name="lat" placeholder="Latitude" readonly class="w-1/2 text-xs bg-white p-2 rounded text-center border border-orange-200 font-mono text-slate-500">
                            <input type="text" id="reg-lng" name="lng" placeholder="Longitude" readonly class="w-1/2 text-xs bg-white p-2 rounded text-center border border-orange-200 font-mono text-slate-500">
                        </div>
                    </div>

                    <button type="submit" id="submitBtn" class="w-full bg-slate-900 text-white font-bold py-4 rounded-xl shadow-lg hover:bg-black active:scale-95 transition transform border border-slate-800">
                        Complete Registration
                    </button>
                    
                    <div id="status-msg" class="text-center text-sm font-semibold hidden p-3 rounded-lg"></div>

                </form>
            </div>
        </div>
    </div>

    <!-- Side Nav Overlay -->
    <div id="sidenav-overlay" onclick="toggleSideNav()" class="fixed inset-0 bg-black/60 z-[60] hidden transition-opacity backdrop-blur-sm"></div>
    
    <!-- Side Nav Drawer -->
    <div id="sidenav" class="fixed top-0 left-0 h-full w-72 bg-slate-900 z-[70] transform -translate-x-full transition-transform duration-300 shadow-2xl flex flex-col text-white">
        <div class="p-8 border-b border-slate-800 bg-slate-950">
            <h2 class="text-2xl font-black tracking-wider">EASY<span class="text-orange-500">MECH</span></h2>
            <p class="text-slate-400 text-xs uppercase tracking-widest mt-1">Professional Network</p>
        </div>
        <nav class="flex-1 p-4 space-y-2 mt-4">
            <a href="#" onclick="navigateTo('home'); toggleSideNav()" class="block px-4 py-3 rounded-lg bg-orange-600 text-white font-bold shadow-md">
                <i class="fas fa-map-marked-alt w-8"></i> Map View
            </a>
            <a href="#" onclick="navigateTo('register'); toggleSideNav()" class="block px-4 py-3 rounded-lg text-slate-300 hover:bg-slate-800 hover:text-white transition font-medium">
                <i class="fas fa-user-plus w-8"></i> Join as Handyman
            </a>
            <div class="px-4 py-3">
                 <div class="h-px bg-slate-800 my-2"></div>
            </div>
            <a href="#" class="block px-4 py-3 rounded-lg text-slate-400 hover:text-white transition text-sm">
                <i class="fas fa-info-circle w-8"></i> About Us
            </a>
        </nav>
        <div class="p-6 border-t border-slate-800 text-center text-xs text-slate-500">
            &copy; 2024 EasyMech App v1.2
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-24 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-xl z-[100] transition-all duration-300 opacity-0 pointer-events-none translate-y-4 text-sm font-bold flex items-center gap-3 border border-slate-700">
        <i class="fas fa-check-circle text-orange-500"></i> <span id="toast-msg">Notification</span>
    </div>

    <!-- Loading Spinner Overlay -->
    <div id="global-loader" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-4 border-slate-200 border-t-orange-600 mb-4"></div>
        <p class="text-slate-800 font-bold uppercase tracking-widest animate-pulse">Initializing Map...</p>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    
    <script>
        // --- CONFIGURATION ---
        const SHEET_ID = '1YRnpw6GJ8c2pZMYTofrYYLJBweWkR1qWvjmucI5_-k8';
        const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzSK72YJAfZlN_7BmljJrbB1kBQ8hn2JA_sAW4ctnoG8MZ2R0d8VVs4nbdrVge_nH5-/exec';
        
        // --- STATE ---
        let map;
        let allData = [];
        let markers = L.layerGroup();
        let userMarker = null;
        let userPos = null;
        let isSheetExpanded = false;
        let processedImageData = null;

        // --- INIT ---
        window.onload = function() {
            initMap();
            fetchData();
            setTimeout(getUserLocation, 1000); // Auto-locate after brief delay
        };

        // --- ROUTING ---
        function navigateTo(viewId, params = null) {
            // Hide all views
            ['view-home', 'view-item', 'view-register'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });

            // Show target view
            const target = document.getElementById(`view-${viewId}`);
            target.classList.remove('hidden');

            // View specific logic
            if (viewId === 'home') {
                // IMPORTANT: Fix map rendering when tab becomes visible
                setTimeout(() => { map.invalidateSize(); }, 200);
            } else if (viewId === 'item' && params) {
                renderProfile(params);
            }
        }

        // --- MAP FUNCTIONS ---
        function initMap() {
            map = L.map('map', {
                zoomControl: false,
                attributionControl: false
            }).setView([5.6037, -0.1870], 13); // Accra default

            L.control.zoom({ position: 'topright' }).addTo(map);

            // Esri Basemap (Streets vs Imagery - Streets looks cleaner for "work" apps)
            // But user requested Esri, we can stick to imagery or switch to 'Topographic' for a map feel
            L.esri.basemapLayer('Imagery').addTo(map);

            markers.addTo(map);
        }

        function getUserLocation() {
            const btn = document.querySelector('.location-btn');
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';

            if (!navigator.geolocation) {
                showToast("Geolocation not supported", "error");
                btn.innerHTML = '<i class="fas fa-location-arrow"></i>';
                return;
            }

            navigator.geolocation.getCurrentPosition(pos => {
                userPos = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                
                // Update map
                if (userMarker) map.removeLayer(userMarker);
                
                // Custom Icon for User
                const userIcon = L.divIcon({
                    className: 'user-marker',
                    html: '<div class="w-4 h-4 bg-orange-600 rounded-full border-2 border-white user-pulse"></div>',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                userMarker = L.marker([userPos.lat, userPos.lng], { icon: userIcon }).addTo(map);
                
                map.flyTo([userPos.lat, userPos.lng], 15);
                btn.innerHTML = '<i class="fas fa-location-arrow"></i>';
                showToast("Location Updated");
                
                // Re-sort list by distance
                renderList(allData);
            }, err => {
                console.error(err);
                btn.innerHTML = '<i class="fas fa-exclamation"></i>';
                showToast("GPS Error. Check settings.", "error");
            }, { enableHighAccuracy: true });
        }

        // --- DATA LOGIC ---
        async function fetchData() {
            try {
                const res = await fetch(SHEET_URL);
                const txt = await res.text();
                // More robust regex parsing to handle potential Google changes
                const jsonString = txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\);/);
                
                if (!jsonString || !jsonString[1]) {
                    throw new Error("Failed to parse Google Sheet data");
                }

                const json = JSON.parse(jsonString[1]);

                allData = json.table.rows.map(row => {
                    const c = row.c;
                    const v = (i) => (c[i] && c[i].v) ? c[i].v : null;
                    
                    // --- IMAGE HANDLING FIX ---
                    let rawImage = v(1);
                    let processedImage = 'https://via.placeholder.com/400x300?text=No+Image';
                    
                    if (rawImage) {
                        // Check if it's a URL
                        if (rawImage.startsWith('http')) {
                            processedImage = rawImage;
                        } 
                        // Check if it's base64 but missing the prefix
                        else if (!rawImage.startsWith('data:image')) {
                            // Assume JPEG if unknown, fixes the "Text but no image" issue
                            processedImage = `data:image/jpeg;base64,${rawImage}`;
                        } else {
                            processedImage = rawImage;
                        }
                    }

                    return {
                        name: v(0), 
                        image: processedImage, 
                        type: v(2),
                        open: v(3) || 8, 
                        close: v(4) || 17,
                        region: v(5), town: v(6),
                        contact: v(7), whatsapp: v(8), desc: v(9),
                        lat: v(10), lng: v(11),
                        id: btoa((v(0) || "") + (v(6) || "")).replace(/=/g, '')
                    };
                }).filter(i => i.lat && i.lng);

                // Populate categories
                const types = [...new Set(allData.map(d => d.type))].filter(Boolean);
                const catContainer = document.getElementById('category-pills');
                catContainer.innerHTML = ''; 
                types.forEach(t => {
                    const btn = document.createElement('button');
                    btn.className = "filter-btn bg-white text-slate-600 px-5 py-2 rounded-lg text-sm font-bold shadow-sm border border-slate-200 mr-2 hover:border-orange-500 hover:text-orange-600 transition-colors whitespace-nowrap";
                    btn.innerText = t;
                    btn.onclick = () => filterData(t, btn);
                    catContainer.appendChild(btn);
                });

                renderList(allData);
                document.getElementById('global-loader').style.display = 'none';

            } catch (e) {
                console.error(e);
                showToast("Error loading data. Check internet.", "error");
                document.getElementById('global-loader').style.display = 'none';
            }
        }

        function filterData(type, btnElement) {
            // UI Update
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.className = "filter-btn bg-white text-slate-600 px-5 py-2 rounded-lg text-sm font-bold shadow-sm border border-slate-200 mr-2 hover:border-orange-500 hover:text-orange-600 transition-colors whitespace-nowrap";
            });
            
            if (!type) {
                document.getElementById('filter-all').className = "filter-btn bg-slate-900 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-sm mr-2 transition-colors border border-slate-900";
                renderList(allData);
            } else {
                if(btnElement) btnElement.className = "filter-btn bg-orange-600 text-white px-5 py-2 rounded-lg text-sm font-bold shadow-sm mr-2 transition-colors border border-orange-600";
                const filtered = allData.filter(d => d.type === type);
                renderList(filtered);
            }
        }

        function renderList(data) {
            const container = document.getElementById('list-container');
            container.innerHTML = '';
            markers.clearLayers();

            // Calculate distance if user pos known
            if (userPos) {
                data.forEach(d => {
                    d.distance = getDistance(userPos.lat, userPos.lng, d.lat, d.lng);
                });
                data.sort((a, b) => a.distance - b.distance);
            }

            document.getElementById('list-header-text').innerText = `${data.length} Handymen Found`;

            if (data.length === 0) {
                container.innerHTML = `<div class="text-center py-10 text-slate-400 font-medium">No results found in this category.</div>`;
                return;
            }

            data.forEach(item => {
                // Map Marker - Using FontAwesome Icons inside Leaflet DivIcon for better look
                const iconHtml = `<div class="w-8 h-8 bg-slate-900 text-white rounded-full border-2 border-white shadow-lg flex items-center justify-center text-xs"><i class="fas fa-wrench"></i></div>`;
                const customIcon = L.divIcon({
                    className: 'custom-pin',
                    html: iconHtml,
                    iconSize: [32, 32],
                    iconAnchor: [16, 32],
                    popupAnchor: [0, -32]
                });

                const marker = L.marker([item.lat, item.lng], {icon: customIcon}).addTo(markers);
                marker.bindPopup(`
                    <div class="p-2 font-sans">
                        <b class="text-slate-900 block mb-1 text-sm">${item.name}</b>
                        <span class="text-xs text-slate-500 block mb-3 uppercase font-bold tracking-wide">${item.type}</span>
                        <button onclick="navigateTo('item', '${item.id}')" class="bg-orange-600 text-white text-xs font-bold px-4 py-2 rounded shadow-md w-full hover:bg-orange-700 transition">View Profile</button>
                    </div>
                `);

                // List Card
                const isOpen = isShopOpen(item.open, item.close);
                const statusColor = isOpen ? 'bg-green-100 text-green-700 border-green-200' : 'bg-red-100 text-red-700 border-red-200';
                const statusText = isOpen ? 'Open' : 'Closed';
                const distText = item.distance ? `<span class="text-xs text-slate-400 font-medium">â€¢ ${item.distance.toFixed(1)} km away</span>` : '';

                const card = document.createElement('div');
                card.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center gap-4 active:bg-slate-50 transition cursor-pointer hover:shadow-md hover:border-orange-200 group";
                card.onclick = () => {
                    if(isSheetExpanded) toggleSheet();
                    map.flyTo([item.lat, item.lng], 16);
                    marker.openPopup();
                };

                card.innerHTML = `
                    <div class="h-16 w-16 rounded-xl bg-slate-200 flex-shrink-0 overflow-hidden border border-slate-100 relative">
                        <img src="${item.image}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/60?text=Error'">
                    </div>
                    <div class="flex-grow min-w-0">
                        <h4 class="font-bold text-slate-800 text-base truncate group-hover:text-orange-600 transition">${item.name}</h4>
                        <p class="text-xs text-slate-500 truncate font-medium uppercase tracking-wide mb-1">${item.type}</p>
                        <div class="flex items-center gap-2">
                            <span class="px-2 py-0.5 rounded text-[10px] font-bold uppercase border ${statusColor}">${statusText}</span>
                            ${distText}
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); navigateTo('item', '${item.id}')" class="bg-slate-100 text-slate-400 h-10 w-10 rounded-full flex items-center justify-center hover:bg-orange-100 hover:text-orange-600 transition">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                `;
                container.appendChild(card);
            });
        }

        // --- ITEM PROFILE LOGIC ---
        function renderProfile(id) {
            const item = allData.find(d => d.id === id);
            if (!item) return;

            // Update DOM
            document.getElementById('profile-name').innerText = item.name;
            document.getElementById('profile-type').innerText = item.type;
            document.getElementById('profile-location').innerText = `${item.town}, ${item.region}`;
            document.getElementById('profile-desc').innerText = item.desc || "No additional details provided by this handyman.";
            document.getElementById('profile-hours').innerText = `${formatTime(item.open)} - ${formatTime(item.close)}`;
            
            const imgEl = document.getElementById('profile-img');
            imgEl.src = item.image;
            imgEl.onerror = function() { this.src = 'https://via.placeholder.com/400x300?text=Image+Error'; };
            
            // Status
            const isOpen = isShopOpen(item.open, item.close);
            const badgeContainer = document.getElementById('profile-badge-container');
            const statusTextEl = document.getElementById('profile-status-text');
            
            if (isOpen) {
                badgeContainer.innerHTML = `<span class="px-3 py-1 rounded-full text-xs font-bold bg-green-500 text-white uppercase shadow-sm">Open Now</span>`;
                statusTextEl.innerText = "Currently Open";
                statusTextEl.className = "font-bold text-green-600";
            } else {
                badgeContainer.innerHTML = `<span class="px-3 py-1 rounded-full text-xs font-bold bg-red-500 text-white uppercase shadow-sm">Closed</span>`;
                statusTextEl.innerText = `Opens at ${formatTime(item.open)}`;
                statusTextEl.className = "font-bold text-red-500";
            }

            // Buttons
            document.getElementById('btn-call').href = `tel:${item.contact}`;
            document.getElementById('btn-whatsapp').href = `https://wa.me/${item.whatsapp}`;
        }

        // --- REGISTRATION FORM LOGIC ---
        // Image Processing
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = function(event) {
                const img = new Image();
                img.src = event.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const maxDim = 800; // Resize to max 800px to save space
                    let width = img.width, height = img.height;

                    if (width > height) {
                        if (width > maxDim) { height *= maxDim / width; width = maxDim; }
                    } else {
                        if (height > maxDim) { width *= maxDim / height; height = maxDim; }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7); // Compress quality 0.7
                    
                    // Preview
                    const preview = document.getElementById('img-preview');
                    preview.src = dataUrl;
                    preview.classList.remove('hidden');
                    
                    // Store
                    processedImageData = {
                        base64: dataUrl.split(',')[1],
                        mimeType: 'image/jpeg',
                        fileName: 'profile_' + Date.now() + '.jpg'
                    };
                };
            };
        });

        // Get Reg Location
        function getRegLocation() {
            const btn = document.getElementById('btn-get-loc');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting GPS...';
            
            if (!navigator.geolocation) {
                alert("Geolocation not supported.");
                return;
            }

            navigator.geolocation.getCurrentPosition(pos => {
                document.getElementById('reg-lat').value = pos.coords.latitude.toFixed(6);
                document.getElementById('reg-lng').value = pos.coords.longitude.toFixed(6);
                btn.innerHTML = '<i class="fas fa-check-circle"></i> Location Captured';
                btn.classList.remove('bg-white', 'text-orange-600');
                btn.classList.add('bg-green-100', 'text-green-700', 'border-green-200');
            }, () => {
                alert("Could not get location. Ensure GPS is on.");
                btn.innerHTML = originalText;
            });
        }

        // Submit Form
        document.getElementById('regForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const msg = document.getElementById('status-msg');
            
            if(SCRIPT_URL.includes('PASTE_YOUR')) {
                alert("Script URL not configured.");
                return;
            }

            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> Uploading to Server...';

            const formData = new FormData(this);
            const data = {};
            formData.forEach((value, key) => data[key] = value);
            
            if (processedImageData) {
                data.fileData = processedImageData.base64;
                data.mimeType = processedImageData.mimeType;
                data.fileName = processedImageData.fileName;
            }

            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(() => {
                msg.innerText = "Application Sent Successfully!";
                msg.className = "text-center text-sm font-bold p-4 rounded-xl bg-green-100 text-green-700 block mt-4 border border-green-200";
                btn.innerHTML = '<i class="fas fa-check"></i> Submitted';
                this.reset();
                document.getElementById('img-preview').classList.add('hidden');
                processedImageData = null;
                setTimeout(() => { navigateTo('home'); }, 2000);
            })
            .catch(error => {
                console.error(error);
                msg.innerText = "Submission failed. Please try again.";
                msg.className = "text-center text-sm font-bold p-4 rounded-xl bg-red-100 text-red-700 block mt-4 border border-red-200";
                btn.disabled = false;
                btn.innerText = "Try Again";
            });
        });

        // --- UTILITIES ---
        function toggleSheet() {
            const sheet = document.getElementById('sheet-container');
            const listText = document.getElementById('list-header-text');
            isSheetExpanded = !isSheetExpanded;
            
            if(isSheetExpanded) {
                sheet.classList.remove('translate-y-[calc(100%-80px)]');
                sheet.classList.add('translate-y-0');
                listText.innerText = "Swipe down to minimize";
            } else {
                sheet.classList.add('translate-y-[calc(100%-80px)]');
                sheet.classList.remove('translate-y-0');
                listText.innerText = "Explore Handymen Near You";
            }
        }

        function toggleSideNav() {
            const nav = document.getElementById('sidenav');
            const overlay = document.getElementById('sidenav-overlay');
            const isClosed = nav.classList.contains('-translate-x-full');
            
            if (isClosed) {
                nav.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                nav.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-msg');
            msg.innerText = message;
            toast.style.opacity = '1';
            toast.style.transform = 'translate(-50%, 0)';
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translate(-50%, 16px)';
            }, 3000);
        }

        function isShopOpen(open, close) {
            const h = new Date().getHours();
            return h >= parseInt(open) && h < parseInt(close);
        }
        
        function formatTime(h) {
            const hour = parseInt(h);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const showHour = hour % 12 || 12;
            return `${showHour}:00 ${ampm}`;
        }

        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2-lat1) * Math.PI/180;
            const dLon = (lon2-lon1) * Math.PI/180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
    </script>
</body>
</html>
